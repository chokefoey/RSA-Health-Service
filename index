import React, { useState, useEffect } from 'react';
import { Calculator, Calendar, ClipboardList, Activity, Save, AlertCircle, CheckCircle2, User, FileText, HeartPulse, Stethoscope, Download, Copy, Printer } from 'lucide-react';

// --- Components ---

// 1. ส่วนคำนวณอายุครรภ์ (GA Calculator) - Version ACOG Logic
const GACalculator = () => {
  const [calculationMethod, setCalculationMethod] = useState('lmp'); // 'lmp', 'ultrasound', 'acog'
  const [inputDate, setInputDate] = useState('');
  const [manualGAWeeks, setManualGAWeeks] = useState(0);
  const [manualGADays, setManualGADays] = useState(0);
  
  // State for ACOG comparison
  const [acogLmpDate, setAcogLmpDate] = useState('');
  const [acogUsDate, setAcogUsDate] = useState('');
  const [acogUsWeeks, setAcogUsWeeks] = useState(0);
  const [acogUsDays, setAcogUsDays] = useState(0);

  const [result, setResult] = useState(null);

  const calculateGA = () => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (calculationMethod === 'acog') {
      if (!acogLmpDate || !acogUsDate) return;

      const lmp = new Date(acogLmpDate);
      const usDate = new Date(acogUsDate);
      lmp.setHours(0, 0, 0, 0);
      usDate.setHours(0, 0, 0, 0);

      // 1. Calculate EDD from LMP
      const eddLmp = new Date(lmp);
      eddLmp.setDate(lmp.getDate() + 280);

      // 2. Calculate EDD from Ultrasound
      const usGaTotalDays = (parseInt(acogUsWeeks) * 7) + parseInt(acogUsDays);
      const conceptionDateUs = new Date(usDate);
      conceptionDateUs.setDate(usDate.getDate() - usGaTotalDays);
      
      const eddUs = new Date(conceptionDateUs);
      eddUs.setDate(conceptionDateUs.getDate() + 280);

      // 3. Calculate difference in days
      const diffTime = Math.abs(eddUs - eddLmp);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      // 4. Determine Threshold
      let threshold = 0;
      if (usGaTotalDays < 9 * 7) threshold = 5;
      else if (usGaTotalDays < 14 * 7) threshold = 7;
      else if (usGaTotalDays < 16 * 7) threshold = 7;
      else if (usGaTotalDays < 22 * 7) threshold = 10;
      else if (usGaTotalDays < 28 * 7) threshold = 14;
      else threshold = 21;

      // 5. Decision
      let finalEdd = new Date();
      let methodUsed = '';
      let recommendation = '';

      if (diffDays > threshold) {
        finalEdd = eddUs;
        methodUsed = 'Ultrasound (ปรับแก้ตาม ACOG)';
        recommendation = `ความคลาดเคลื่อน ${diffDays} วัน เกินเกณฑ์ (${threshold} วัน) -> ใช้อายุครรภ์จากอัลตร้าซาวด์`;
      } else {
        finalEdd = eddLmp;
        methodUsed = 'LMP (ประจำเดือน)';
        recommendation = `ความคลาดเคลื่อน ${diffDays} วัน อยู่ในเกณฑ์ (${threshold} วัน) -> ใช้อายุครรภ์จากประจำเดือน`;
      }

      // Calculate Current GA based on Final EDD
      const timeToEdd = finalEdd - today;
      const daysToEdd = Math.ceil(timeToEdd / (1000 * 60 * 60 * 24));
      const currentGaDays = 280 - daysToEdd;
      
      const currentWeeks = Math.floor(currentGaDays / 7);
      const currentDays = currentGaDays % 7;

      setResult({
        weeks: currentWeeks,
        days: currentDays,
        edd: finalEdd.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }),
        method: methodUsed,
        note: recommendation,
        diffDays: diffDays,
        threshold: threshold
      });

    } else {
      // Logic for Simple LMP or US
      if (!inputDate) return;

      const start = new Date(inputDate);
      start.setHours(0, 0, 0, 0);
      
      const diffTime = Math.abs(today - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

      let totalDays = 0;

      if (calculationMethod === 'lmp') {
        totalDays = diffDays;
      } else {
        const gaAtUltrasoundDays = (parseInt(manualGAWeeks) * 7) + parseInt(manualGADays);
        totalDays = diffDays + gaAtUltrasoundDays;
      }

      const weeks = Math.floor(totalDays / 7);
      const days = totalDays % 7;

      const estimatedLMP = new Date(today);
      estimatedLMP.setDate(today.getDate() - totalDays);
      
      const edd = new Date(estimatedLMP);
      edd.setDate(estimatedLMP.getDate() + 280);

      setResult({
        weeks,
        days,
        edd: edd.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }),
        method: calculationMethod === 'lmp' ? 'ประจำเดือนครั้งสุดท้าย (LMP)' : 'อัลตร้าซาวด์'
      });
    }
  };

  return (
    <div className="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-sm border border-pink-100">
      <h2 className="text-2xl font-bold text-pink-600 mb-6 flex items-center gap-2">
        <Calculator className="w-6 h-6" />
        คำนวณอายุครรภ์ (Gestational Age)
      </h2>

      <div className="flex flex-wrap gap-2 mb-6">
        <button
          onClick={() => { setCalculationMethod('lmp'); setResult(null); }}
          className={`flex-1 py-2 px-3 rounded-lg border text-sm font-medium transition-all ${
            calculationMethod === 'lmp' 
              ? 'bg-pink-50 border-pink-500 text-pink-700' 
              : 'border-gray-200 text-gray-500 hover:bg-gray-50'
          }`}
        >
          จากประจำเดือน
        </button>
        <button
          onClick={() => { setCalculationMethod('ultrasound'); setResult(null); }}
          className={`flex-1 py-2 px-3 rounded-lg border text-sm font-medium transition-all ${
            calculationMethod === 'ultrasound' 
              ? 'bg-blue-50 border-blue-500 text-blue-700' 
              : 'border-gray-200 text-gray-500 hover:bg-gray-50'
          }`}
        >
          จากอัลตร้าซาวด์
        </button>
        <button
          onClick={() => { setCalculationMethod('acog'); setResult(null); }}
          className={`flex-1 py-2 px-3 rounded-lg border text-sm font-medium transition-all ${
            calculationMethod === 'acog' 
              ? 'bg-purple-50 border-purple-500 text-purple-700' 
              : 'border-gray-200 text-gray-500 hover:bg-gray-50'
          }`}
        >
          ตรวจสอบ (ACOG)
        </button>
      </div>

      <div className="space-y-4">
        {calculationMethod === 'acog' ? (
          <div className="space-y-4 animate-fade-in">
            <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
              <h4 className="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <span className="w-6 h-6 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center text-xs">1</span>
                ข้อมูลประจำเดือน (LMP)
              </h4>
              <div className="ml-8">
                <label className="block text-sm font-medium text-gray-600 mb-1">วันที่ประจำเดือนมาวันแรกครั้งสุดท้าย</label>
                <input
                  type="date"
                  className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-pink-400 outline-none"
                  value={acogLmpDate}
                  onChange={(e) => setAcogLmpDate(e.target.value)}
                />
              </div>
            </div>

            <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
              <h4 className="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <span className="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs">2</span>
                ข้อมูลอัลตร้าซาวด์ (Ultrasound)
              </h4>
              <div className="ml-8 space-y-3">
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">วันที่ตรวจอัลตร้าซาวด์</label>
                  <input
                    type="date"
                    className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 outline-none"
                    value={acogUsDate}
                    onChange={(e) => setAcogUsDate(e.target.value)}
                  />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-600 mb-1">อายุครรภ์ (สัปดาห์)</label>
                    <input
                      type="number" min="0"
                      className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 outline-none"
                      value={acogUsWeeks}
                      onChange={(e) => setAcogUsWeeks(e.target.value)}
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-600 mb-1">อายุครรภ์ (วัน)</label>
                    <input
                      type="number" min="0" max="6"
                      className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 outline-none"
                      value={acogUsDays}
                      onChange={(e) => setAcogUsDays(e.target.value)}
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        ) : (
          /* Simple Modes */
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {calculationMethod === 'lmp' ? 'วันที่ประจำเดือนมาวันแรกของครั้งสุดท้าย' : 'วันที่ตรวจอัลตร้าซาวด์'}
            </label>
            <input
              type="date"
              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent outline-none"
              value={inputDate}
              onChange={(e) => setInputDate(e.target.value)}
            />
            {calculationMethod === 'ultrasound' && (
              <div className="grid grid-cols-2 gap-4 mt-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">อายุครรภ์ที่วัดได้ (สัปดาห์)</label>
                  <input
                    type="number"
                    min="0"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 outline-none"
                    value={manualGAWeeks}
                    onChange={(e) => setManualGAWeeks(e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">อายุครรภ์ที่วัดได้ (วัน)</label>
                  <input
                    type="number"
                    min="0"
                    max="6"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 outline-none"
                    value={manualGADays}
                    onChange={(e) => setManualGADays(e.target.value)}
                  />
                </div>
              </div>
            )}
          </div>
        )}

        <button
          onClick={calculateGA}
          className="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg transition-colors mt-4 shadow-md"
        >
          {calculationMethod === 'acog' ? 'ประมวลผลการตรวจสอบ' : 'คำนวณอายุครรภ์'}
        </button>
      </div>

      {result && (
        <div className="mt-8 p-6 bg-green-50 rounded-xl border border-green-200 animate-fade-in">
          <h3 className="text-lg font-semibold text-green-800 mb-4 border-b border-green-200 pb-2">
            {calculationMethod === 'acog' ? 'สรุปผลการตรวจสอบ (ACOG Recommendation)' : 'ผลการคำนวณ'}
          </h3>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="text-center p-4 bg-white rounded-lg shadow-sm">
              <p className="text-sm text-gray-500 mb-1">อายุครรภ์ปัจจุบัน (วันนี้)</p>
              <p className="text-3xl font-bold text-pink-600">
                {result.weeks} <span className="text-lg text-gray-600">สัปดาห์</span> {result.days} <span className="text-lg text-gray-600">วัน</span>
              </p>
            </div>
            <div className="text-center p-4 bg-white rounded-lg shadow-sm">
              <p className="text-sm text-gray-500 mb-1">วันกำหนดคลอด (EDD)</p>
              <p className="text-xl font-bold text-blue-600 mt-2">{result.edd}</p>
              <p className="text-xs text-gray-400 mt-1">อ้างอิงจาก: {result.method}</p>
            </div>
          </div>

          {result.note && (
            <div className="mt-4 p-3 bg-white rounded-lg border border-purple-100">
              <div className="flex items-start gap-2">
                <CheckCircle2 className="w-5 h-5 text-purple-600 shrink-0 mt-0.5" />
                <div>
                  <p className="font-semibold text-purple-800 text-sm">คำแนะนำทางการแพทย์</p>
                  <p className="text-sm text-gray-700">{result.note}</p>
                </div>
              </div>
              <div className="mt-2 text-xs text-gray-400 pl-7">
                *เกณฑ์ ACOG: US {result.threshold} วัน (ผลต่าง {result.diffDays} วัน)
              </div>
            </div>
          )}
          
          {!result.note && (
            <p className="text-xs text-center text-gray-500 mt-4">
              *เป็นการคำนวณเบื้องต้น ควรได้รับการยืนยันทางการแพทย์อีกครั้ง
            </p>
          )}
        </div>
      )}
    </div>
  );
};

// 2. แบบคัดกรองโรคซึมเศร้า 9Q (Standalone Tool)
const DepressionScreening = () => {
  const [scores, setScores] = useState({});
  const [totalScore, setTotalScore] = useState(0);
  const [interpretation, setInterpretation] = useState(null);

  const questions = [
    "1. เบื่อ ไม่สนใจอยากทำอะไร",
    "2. ไม่สบายใจ ซึมเศร้า ท้อแท้",
    "3. หลับยาก หรือหลับๆ ตื่นๆ หรือหลับมากไป",
    "4. เหนื่อยง่าย หรือ ไม่ค่อยมีแรง",
    "5. เบื่ออาหาร หรือ กินมากเกินไป",
    "6. รู้สึกไม่ดีกับตัวเอง คิดว่าตัวเองล้มเหลว หรือทำให้ตนเองหรือครอบครัวผิดหวัง",
    "7. สมาธิไม่ดีเวลาทำอะไร เช่น ดูโทรทัศน์ ฟังวิทยุ หรือทำงานที่ต้องใช้ความตั้งใจ",
    "8. พูดช้า ทำอะไรช้าลง จนคนอื่นสังเกตเห็นได้ หรือกระสับกระส่ายไม่นิ่งเหมือนที่เคย",
    "9. คิดทำร้ายตนเอง หรือคิดว่าถ้าตายไปคงจะดี"
  ];

  const choices = [
    { label: "ไม่มีเลย", value: 0 },
    { label: "เป็นบางวัน (น้อยกว่า 7 วัน)", value: 1 },
    { label: "เป็นบ่อย (มากกว่า 7 วัน)", value: 2 },
    { label: "เป็นทุกวัน", value: 3 }
  ];

  const handleScoreChange = (qIndex, value) => {
    const newScores = { ...scores, [qIndex]: value };
    setScores(newScores);
    
    // Calculate total immediately
    const total = Object.values(newScores).reduce((a, b) => a + b, 0);
    setTotalScore(total);
  };

  useEffect(() => {
    if (Object.keys(scores).length > 0) {
      if (totalScore < 7) {
        setInterpretation({ text: "ปกติ", color: "text-green-600", bg: "bg-green-100", advice: "ท่านไม่มีอาการซึมเศร้าหรือมีระดับน้อยมาก" });
      } else if (totalScore <= 12) {
        setInterpretation({ text: "ซึมเศร้าระดับน้อย", color: "text-yellow-600", bg: "bg-yellow-100", advice: "ควรได้รับคำปรึกษาหรือพูดคุยระบายความรู้สึก" });
      } else if (totalScore <= 18) {
        setInterpretation({ text: "ซึมเศร้าระดับปานกลาง", color: "text-orange-600", bg: "bg-orange-100", advice: "สมควรส่งพบแพทย์เพื่อประเมินและรักษา" });
      } else {
        setInterpretation({ text: "ซึมเศร้าระดับรุนแรง", color: "text-red-600", bg: "bg-red-100", advice: "ต้องรีบพบแพทย์โดยด่วนเพื่อรับการรักษา" });
      }
    }
  }, [totalScore, scores]);

  return (
    <div className="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow-sm border border-purple-100">
      <div className="mb-6">
        <h2 className="text-2xl font-bold text-purple-700 flex items-center gap-2">
          <HeartPulse className="w-6 h-6" />
          แบบคัดกรองโรคซึมเศร้า 9Q
        </h2>
        <p className="text-sm text-gray-500 mt-2">
          ในช่วง 2 สัปดาห์ที่ผ่านมา รวมวันนี้ ท่านมีอาการเหล่านี้บ่อยแค่ไหน?
        </p>
      </div>

      <div className="space-y-6">
        {questions.map((q, index) => (
          <div key={index} className="pb-4 border-b border-gray-100 last:border-0">
            <p className="font-medium text-gray-800 mb-3">{q}</p>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
              {choices.map((c) => (
                <label key={c.value} className={`
                  flex flex-col items-center justify-center p-3 rounded-lg cursor-pointer border transition-all
                  ${scores[index] === c.value 
                    ? 'bg-purple-50 border-purple-500 text-purple-700 shadow-sm' 
                    : 'bg-white border-gray-200 hover:bg-gray-50 text-gray-600'}
                `}>
                  <input
                    type="radio"
                    name={`q-${index}`}
                    value={c.value}
                    onChange={() => handleScoreChange(index, c.value)}
                    className="sr-only"
                  />
                  <span className="text-sm text-center">{c.label}</span>
                </label>
              ))}
            </div>
          </div>
        ))}
      </div>

      {Object.keys(scores).length > 0 && (
        <div className="sticky bottom-4 mt-8 p-4 bg-white rounded-xl shadow-lg border border-purple-200 z-10">
          <div className="flex flex-col md:flex-row items-center justify-between gap-4">
            <div>
              <span className="text-gray-500">คะแนนรวม:</span>
              <span className="text-3xl font-bold text-purple-700 ml-2">{totalScore}</span>
            </div>
            {interpretation && (
              <div className={`flex-1 w-full md:w-auto p-3 rounded-lg ${interpretation.bg} flex items-center gap-3`}>
                <AlertCircle className={`w-5 h-5 ${interpretation.color}`} />
                <div>
                  <p className={`font-bold ${interpretation.color}`}>{interpretation.text}</p>
                  <p className="text-xs text-gray-700">{interpretation.advice}</p>
                </div>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

// 3. แบบบันทึกการยุติการตั้งครรภ์ (Re-styled based on image)
const AbortionRecordForm = () => {
  const [formData, setFormData] = useState({
    name: '',
    age: '',
    idCard: '',
    ultrasoundDate: '',
    ultrasoundMonth: '',
    ultrasoundYear: '',
    gaWeeks: '',
    hasIUD: '',
    historyCSection: '',
    livingChildren: '',
    disease: '',
    drugAllergy: '',
    travelTime: '', // 'yes' or 'no'
    hasCaretaker: '', // 'yes' or 'no'
    acceptSideEffects: '', // 'accept' or 'cannot_accept'
    contraceptionPlan: '',
    confirmAbortion: false,
    guardianName: '',
    guardianTel: '',
    counselorName: '',
    hospital: '',
    province: '',
    counselorTel: '',
    approvingDoctorName: '',
    healthIndication: 'mental', // 'mental' or 'physical'
    approvingLicenseNo: '',
    performingDoctorName: '',
    performingLicenseNo: '',
    performingHospital: '',
    diagnosis: 'Depression with unwanted pregnancy.',
    treatment: '',
    dateDay: '',
    dateMonth: '',
    dateYear: ''
  });

  const [scores, setScores] = useState({});
  const [columnScores, setColumnScores] = useState({ col1: 0, col2: 0, col3: 0 });
  const [totalScore, setTotalScore] = useState(0);

  // For copy feedback
  const [showCopyFeedback, setShowCopyFeedback] = useState(false);

  const questions = [
    "1. เบื่อๆ ไม่สนใจอยากทำอะไร",
    "2. ไม่สบายใจ ซึมเศร้า ท้อแท้",
    "3. หลับยาก หรือหลับๆ ตื่นๆ หรือหลับมากไป",
    "4. เหนื่อยง่าย หรือไม่ค่อยมีแรง",
    "5. เบื่ออาหาร หรือกินมากไป",
    "6. รู้สึกไม่ดีกับตัวเอง คิดว่าตัวเองล้มเหลว หรือ ทำให้ตนเองหรือครอบครัวผิดหวัง",
    "7. สมาธิไม่ดีเวลาทำอะไร เช่น ดูโทรทัศน์ ฟังวิทยุ หรือทำงานที่ต้องใช้ความตั้งใจ",
    "8. พูดช้า ทำอะไรช้าลง จนถูกสังเกตได้ หรือ กระสับกระส่าย ไม่นิ่งได้เหมือนที่เคย",
    "9. คิดทำร้ายตนเอง หรือคิดว่าตายไปคงจะดี"
  ];

  const handleScoreChange = (qIndex, value, colIndex) => {
    const newScores = { ...scores, [qIndex]: { value, colIndex } };
    setScores(newScores);

    // Recalculate column scores
    let c1 = 0, c2 = 0, c3 = 0;
    Object.values(newScores).forEach(s => {
      if (s.colIndex === 1) c1 += s.value;
      if (s.colIndex === 2) c2 += s.value;
      if (s.colIndex === 3) c3 += s.value;
    });
    setColumnScores({ col1: c1, col2: c2, col3: c3 });
    setTotalScore(c1 + c2 + c3);
  };

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }));
  };

  const handlePrint = () => {
    window.print();
  };

  const handleCopyToClipboard = () => {
    // Construct TSV (Tab Separated Values) string for pasting into Sheets
    const fields = [
      formData.name,
      formData.age,
      formData.idCard,
      `${formData.ultrasoundDate}/${formData.ultrasoundMonth}/${formData.ultrasoundYear}`,
      formData.gaWeeks,
      formData.hasIUD,
      formData.historyCSection,
      formData.livingChildren,
      formData.disease,
      formData.drugAllergy,
      formData.travelTime,
      formData.hasCaretaker,
      formData.acceptSideEffects,
      formData.contraceptionPlan,
      totalScore,
      formData.approvingDoctorName,
      formData.performingDoctorName,
      formData.diagnosis
    ];

    const tsvData = fields.join('\t');
    
    navigator.clipboard.writeText(tsvData).then(() => {
      setShowCopyFeedback(true);
      setTimeout(() => setShowCopyFeedback(false), 3000);
    });
  };

  const handleExportCSV = () => {
    // Add BOM for Excel UTF-8 compatibility
    const BOM = "\uFEFF"; 
    const headers = [
      "ชื่อ", "อายุ", "เลขบัตรประชาชน", "วันที่อัลตร้าซาวด์", "อายุครรภ์(สัปดาห์)", 
      "ใส่ห่วงอนามัย", "เคยผ่าคลอด", "บุตรที่มีชีวิต", "โรคประจำตัว", "แพ้ยา",
      "ไป รพ.ใน 1 ชม.", "มีคนดูแล", "ยอมรับผลข้างเคียง", "แผนคุมกำเนิด",
      "คะแนนซึมเศร้า 9Q", "แพทย์ผู้เห็นชอบ", "แพทย์ผู้ทำหัตถการ", "การวินิจฉัย"
    ];

    const data = [
      formData.name,
      formData.age,
      `'${formData.idCard}`, // Force string for ID
      `${formData.ultrasoundDate} ${formData.ultrasoundMonth} ${formData.ultrasoundYear}`,
      formData.gaWeeks,
      formData.hasIUD,
      formData.historyCSection,
      formData.livingChildren,
      formData.disease,
      formData.drugAllergy,
      formData.travelTime,
      formData.hasCaretaker,
      formData.acceptSideEffects,
      formData.contraceptionPlan,
      totalScore,
      formData.approvingDoctorName,
      formData.performingDoctorName,
      formData.diagnosis
    ];

    const csvContent = BOM + headers.join(",") + "\n" + data.map(field => `"${field || ''}"`).join(",");
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `บันทึกยุติการตั้งครรภ์_${formData.name || 'unnamed'}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const Checkbox = ({ checked, label, name, value, onChange }) => (
    <label className="flex items-center gap-1 cursor-pointer mx-1 whitespace-nowrap">
      <div className={`w-4 h-4 border border-black flex items-center justify-center ${checked ? 'bg-black text-white' : 'bg-white'}`}>
        {checked && <div className="w-2 h-2 bg-white rounded-sm" />} 
        {/* Using a pseudo checkmark visual since printed forms use checks or Xs */}
      </div>
      <input type="checkbox" className="hidden" name={name} checked={checked} onChange={onChange} value={value} />
      <span className="leading-none">{label}</span>
    </label>
  );

  const RadioBox = ({ checked, label, name, value, onChange }) => (
    <label className="flex items-center gap-1 cursor-pointer mx-1 whitespace-nowrap">
      <div className={`w-4 h-4 border border-black flex items-center justify-center`}>
        {checked && <div className="w-2 h-2 bg-black" />}
      </div>
      <input type="radio" className="hidden" name={name} checked={checked} onChange={() => onChange({ target: { name, value } })} value={value} />
      <span className="leading-none">{label}</span>
    </label>
  );

  return (
    <div className="max-w-[210mm] mx-auto bg-white p-8 shadow-md print:shadow-none print:p-0 font-sarabun text-black text-sm leading-relaxed relative">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap');
        .font-sarabun { font-family: 'Sarabun', sans-serif; }
        .dotted-line { border-bottom: 1px dotted #000; }
        input[type="text"], input[type="number"] { background: transparent; outline: none; text-align: center; }
        .table-border { border: 1px solid black; }
        .table-border th, .table-border td { border: 1px solid black; padding: 4px; }
      `}</style>
      
      {/* Feedback Message */}
      {showCopyFeedback && (
        <div className="fixed top-20 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-bounce">
          <CheckCircle2 className="w-5 h-5" />
          <div>
            <p className="font-bold">คัดลอกข้อมูลแล้ว!</p>
            <p className="text-xs">ไปที่ Google Sheet แล้วกด Ctrl+V เพื่อวาง</p>
          </div>
        </div>
      )}

      <div className="flex flex-wrap justify-end mb-4 print:hidden gap-2">
        <button 
          onClick={handleCopyToClipboard}
          className="flex items-center gap-2 bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 transition-colors text-sm"
          title="คัดลอกข้อมูลเพื่อนำไปวางใน Google Sheets"
        >
          <Copy className="w-4 h-4" />
          คัดลอกลง Google Sheets
        </button>
        <button 
          onClick={handleExportCSV}
          className="flex items-center gap-2 bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 transition-colors text-sm"
        >
          <Download className="w-4 h-4" />
          ส่งออก Excel/CSV
        </button>
        <button 
          onClick={handlePrint}
          className="flex items-center gap-2 bg-gray-800 text-white px-3 py-2 rounded hover:bg-gray-700 transition-colors text-sm"
        >
          <Printer className="w-4 h-4" />
          พิมพ์ (PDF)
        </button>
      </div>

      <div id="printable-area">
        {/* Header */}
        <div className="text-center mb-2">
          <h1 className="font-bold text-lg underline decoration-1">แบบบันทึก เพื่อยุติการตั้งครรภ์ทางการแพทย์ (ทำแท้งเพื่อการรักษา)</h1>
          <div className="flex justify-between items-end mt-1">
            <span className="font-bold">ตามกฎหมาย ม.305 และ ข้อบังคับแพทยสภา ปี 2548</span>
            <span className="text-right">(เพื่อเก็บไว้เป็นหลักฐานที่สถานบริการ)</span>
          </div>
        </div>

        {/* Instructions */}
        <div className="mb-2">
          จงเติมคำ หรือใส่เครื่องหมาย <span className="inline-block border border-black px-1 text-xs">✓</span> ลงในช่อง <div className="inline-block w-4 h-4 border border-black align-middle mx-1"></div> ตามความเป็นจริง ข้อมูลนี้จะมีผลต่อการพิจารณาในการรักษา และจะเก็บเป็นความลับ
        </div>

        {/* Form Fields */}
        <div className="space-y-1">
          {/* Row 1 */}
          <div className="flex flex-wrap items-baseline">
            <span>1. ชื่อผู้ตั้งครรภ์ไม่พร้อม</span>
            <input type="text" name="name" value={formData.name} onChange={handleChange} className="dotted-line flex-grow mx-2 min-w-[100px]" />
            <span>อายุ</span>
            <input type="number" name="age" value={formData.age} onChange={handleChange} className="dotted-line w-12 mx-2" />
            <span>ปี เลขที่บัตรประชาชน</span>
            <input type="text" name="idCard" value={formData.idCard} onChange={handleChange} className="dotted-line flex-grow mx-2 min-w-[150px]" />
          </div>

          {/* Row 2 */}
          <div className="flex flex-wrap items-baseline">
            <span>2. ผลการทำอัลตร้าซาวด์ล่าสุด เมื่อวันที่</span>
            <input type="text" name="ultrasoundDate" value={formData.ultrasoundDate} onChange={handleChange} className="dotted-line w-12 mx-1" placeholder="" />
            <span>เดือน</span>
            <input type="text" name="ultrasoundMonth" value={formData.ultrasoundMonth} onChange={handleChange} className="dotted-line w-20 mx-1" />
            <span>พ.ศ.</span>
            <input type="text" name="ultrasoundYear" value={formData.ultrasoundYear} onChange={handleChange} className="dotted-line w-16 mx-1" />
            <span className="ml-auto">พบว่าตั้งครรภ์ได้</span>
            <input type="number" name="gaWeeks" value={formData.gaWeeks} onChange={handleChange} className="dotted-line w-16 mx-2" />
            <span>สัปดาห์</span>
          </div>

          {/* Row 3 */}
          <div className="flex flex-wrap items-baseline">
            <span>3. ใส่ห่วงอนามัยค้างอยู่หรือไม่</span>
            <input type="text" name="hasIUD" value={formData.hasIUD} onChange={handleChange} className="dotted-line w-32 mx-2" placeholder="ใส่/ไม่ใส่" />
            <span>เคยผ่าท้องคลอดหรือไม่</span>
            <input type="text" name="historyCSection" value={formData.historyCSection} onChange={handleChange} className="dotted-line w-32 mx-2" placeholder="เคย/ไม่เคย" />
            <span className="ml-auto">มีบุตรที่มีชีวิตอยู่</span>
            <input type="number" name="livingChildren" value={formData.livingChildren} onChange={handleChange} className="dotted-line w-16 mx-2" />
            <span>คน</span>
          </div>

          {/* Row 4 */}
          <div className="flex flex-wrap items-baseline">
            <span>4. มีโรคประจำตัวคือ</span>
            <input type="text" name="disease" value={formData.disease} onChange={handleChange} className="dotted-line flex-grow mx-2" />
            <span>แพ้ยาชื่อ</span>
            <input type="text" name="drugAllergy" value={formData.drugAllergy} onChange={handleChange} className="dotted-line flex-grow mx-2" />
          </div>

          {/* Row 5 */}
          <div className="flex flex-wrap items-center">
            <span>5. คุณสามารถไปถึงโรงพยาบาลใกล้บ้านภายในเวลาไม่เกิน 1 ชั่วโมงได้ไหม</span>
            <div className="ml-4 flex gap-4">
              <RadioBox name="travelTime" value="yes" label="ได้" checked={formData.travelTime === 'yes'} onChange={handleChange} />
              <RadioBox name="travelTime" value="no" label="ไม่ได้" checked={formData.travelTime === 'no'} onChange={handleChange} />
            </div>
          </div>

          {/* Row 6 */}
          <div className="flex flex-wrap items-center">
            <span>6. คุณหาคนอยู่ดูแลใกล้ชิด ขณะใช้ยายุติการตั้งครรภ์ ได้หรือไม่</span>
            <div className="ml-16 flex gap-4">
              <RadioBox name="hasCaretaker" value="yes" label="หาได้" checked={formData.hasCaretaker === 'yes'} onChange={handleChange} />
              <RadioBox name="hasCaretaker" value="no" label="หาไม่ได้" checked={formData.hasCaretaker === 'no'} onChange={handleChange} />
            </div>
          </div>

          {/* Row 7 */}
          <div className="flex flex-wrap items-start">
            <span className="mr-1">7.</span>
            <div className="flex-1">
              <span>การใช้ยายุติการตั้งครรภ์ อาจมีผลข้างเคียง/แทรกซ้อนต่างๆ เช่น ไข้ คลื่นไส้ อาเจียน ปวดท้อง ท้องเสีย ตกเลือด แท้งไม่ครบ ติดเชื้อฯ และอาจต้องปรึกษา/รักษาโดยพยาบาล/แพทย์เพิ่มเติม ซึ่งคุณ</span>
              <div className="inline-flex ml-4 gap-4">
                <RadioBox name="acceptSideEffects" value="accept" label="ยอมรับได้" checked={formData.acceptSideEffects === 'accept'} onChange={handleChange} />
                <RadioBox name="acceptSideEffects" value="cannot_accept" label="ยอมรับไม่ได้" checked={formData.acceptSideEffects === 'cannot_accept'} onChange={handleChange} />
              </div>
            </div>
          </div>

          {/* Row 8 */}
          <div className="flex flex-wrap items-baseline">
            <span>8. หลังยุติการตั้งครรภ์สำเร็จแล้ว เมื่อยังไม่พร้อมตั้งท้อง คุณคิดว่า จะคุมกำเนิดวิธีใด</span>
            <input type="text" name="contraceptionPlan" value={formData.contraceptionPlan} onChange={handleChange} className="dotted-line flex-grow mx-2" />
          </div>

           {/* Row 9 */}
           <div className="flex flex-wrap items-center mt-2">
            <span>9. หลังจากตอบแบบบันทึกนี้แล้ว คุณขอยืนยันว่า</span>
            <div className="ml-4">
              <label className="flex items-center gap-1 font-bold cursor-pointer">
                <div className={`w-4 h-4 border border-black flex items-center justify-center`}>
                  {formData.confirmAbortion && <div className="w-2 h-2 bg-black" />}
                </div>
                <input type="checkbox" className="hidden" checked={formData.confirmAbortion} onChange={(e) => setFormData({...formData, confirmAbortion: e.target.checked})} />
                ขอให้แพทย์ยุติการตั้งครรภ์เพื่อการรักษาให้
              </label>
            </div>
          </div>
        </div>

        {/* 9Q Section */}
        <div className="mt-4">
          <div className="text-center font-bold underline mb-1">แบบคัดกรองโรคซึมเศร้า 9Q</div>
          <div className="text-center text-sm mb-1">(คัดลอกมาจากเอกสารของ กรมสุขภาพจิต กระทรวงสาธารณสุข)</div>
          <div className="text-center mb-2 font-bold">
            คำแนะนำ <span className="font-normal">ผู้ประเมินกาเครื่องหมาย ✓ ในช่องที่ตรงกับคำตอบของผู้รับบริการ (ถ้าไม่เข้าใจให้ถามซ้ำ)</span>
          </div>

          <table className="w-full table-border border-collapse text-sm">
            <thead>
              <tr className="bg-white">
                <th className="text-left align-bottom w-[50%] p-2">
                  คำถาม : ช่วง 2 สัปดาห์ที่ผ่านมา รวมวันนี้<br/>
                  <span className="pl-4">ท่านมีอาการเหล่านี้ บ่อยแค่ไหน</span>
                </th>
                <th className="align-middle text-center w-[10%]">ไม่มี<br/>เลย</th>
                <th className="align-middle text-center w-[15%]">บางวัน<br/><span className="text-xs font-normal">(น้อยกว่า 7 วัน)</span></th>
                <th className="align-middle text-center w-[15%]">บ่อย<br/><span className="text-xs font-normal">(มากกว่า 7 วัน)</span></th>
                <th className="align-middle text-center w-[10%]">ทุกวัน</th>
              </tr>
            </thead>
            <tbody>
              {questions.map((q, index) => (
                <tr key={index}>
                  <td className="p-1 pl-2">{q}</td>
                  {[0, 1, 2, 3].map((val, colIdx) => {
                     const scoreVal = val; 
                     const isChecked = scores[index]?.value === scoreVal;
                     return (
                      <td key={colIdx} className="text-center align-middle cursor-pointer hover:bg-gray-50" onClick={() => handleScoreChange(index, scoreVal, scoreVal)}>
                        <div className="w-full h-full flex justify-center items-center">
                          {isChecked ? '✓' : ''}
                        </div>
                      </td>
                     );
                  })}
                </tr>
              ))}
              <tr>
                <td className="text-right font-bold pr-4 bg-gray-50">(ช่องนี้สำหรับเจ้าหน้าที่)  รวมคะแนน แต่ละช่อง</td>
                <td className="bg-gray-100"></td>
                <td>(x1)= {columnScores.col1 || ''}</td>
                <td>(x2)= {columnScores.col2 || ''}</td>
                <td>(x3)= {columnScores.col3 || ''}</td>
              </tr>
            </tbody>
          </table>
        </div>

        {/* Signatures */}
        <div className="mt-4 space-y-2">
          <div className="flex flex-wrap items-baseline">
            <span>* ลงชื่อ</span>
            <div className="dotted-line w-40 mx-2 h-5"></div>
            <span>ผู้ตั้งครรภ์ไม่พร้อม</span>
            <span className="ml-4">โทร.</span>
            <input type="text" className="dotted-line flex-grow mx-2" />
            <span>วันที่</span>
            <input type="text" name="dateDay" value={formData.dateDay} onChange={handleChange} className="dotted-line w-8 mx-1 text-center" />
            <span>เดือน</span>
            <input type="text" name="dateMonth" value={formData.dateMonth} onChange={handleChange} className="dotted-line w-20 mx-1 text-center" />
            <span>พ.ศ.</span>
            <input type="text" name="dateYear" value={formData.dateYear} onChange={handleChange} className="dotted-line w-12 mx-1 text-center" />
          </div>
          <div className="flex flex-wrap items-baseline">
            <span>* ลงชื่อ</span>
            <div className="dotted-line w-40 mx-2 h-5"></div>
            <span>ผู้ปกครอง, ผู้นำพามา</span>
            <span className="ml-4">โทร.</span>
            <input type="text" name="guardianTel" value={formData.guardianTel} onChange={handleChange} className="dotted-line flex-grow mx-2" />
          </div>
        </div>

        <hr className="border-t-2 border-black my-4" />

        {/* Staff Section */}
        <div className="space-y-2">
          <div className="font-bold flex items-baseline">
            <span>สำหรับเจ้าหน้าที่</span>
            <span className="mx-2 font-normal">รวมผลตรวจคัดกรองโรคซึมเศร้า</span>
            <span className="dotted-line w-16 text-center">{totalScore}</span>
            <span className="mx-2 font-normal">คะแนน</span>
          </div>
          
          <div className="text-sm italic ml-4">
            การแปลผล : 7-12 คะแนน เป็นโรคซึมเศร้าระดับน้อย ให้การปรึกษา // 13-18 คะแนน เป็นโรคซึมเศร้าระดับปานกลาง สมควรส่งพบแพทย์ // มากกว่า 19 คะแนน เป็นโรคซึมเศร้าระดับรุนแรง สมควรส่งพบแพทย์
          </div>

          <div className="flex flex-wrap items-baseline">
             <span>* ลงชื่อผู้ให้คำปรึกษา</span>
             <input type="text" name="counselorName" value={formData.counselorName} onChange={handleChange} className="dotted-line w-40 mx-2" />
             <span>รพ.</span>
             <input type="text" name="hospital" value={formData.hospital} onChange={handleChange} className="dotted-line w-32 mx-2" />
             <span>จังหวัด</span>
             <input type="text" name="province" value={formData.province} onChange={handleChange} className="dotted-line w-24 mx-2" />
             <span>โทร.</span>
             <input type="text" name="counselorTel" value={formData.counselorTel} onChange={handleChange} className="dotted-line flex-grow mx-2" />
          </div>

          <div className="flex flex-wrap items-baseline">
             <span>* ลงชื่อแพทย์ ผู้เห็นชอบ</span>
             <input type="text" name="approvingDoctorName" value={formData.approvingDoctorName} onChange={handleChange} className="dotted-line w-40 mx-2" />
             <span>ให้ยุติการตั้งครรภ์เพราะมีปัญหาสุขภาพทาง</span>
             <div className="flex gap-4 ml-2 items-center">
                <Checkbox name="healthIndication" value="mental" label="จิตใจ" checked={formData.healthIndication === 'mental'} onChange={() => setFormData({...formData, healthIndication: 'mental'})} />
                <Checkbox name="healthIndication" value="physical" label="ร่างกาย" checked={formData.healthIndication === 'physical'} onChange={() => setFormData({...formData, healthIndication: 'physical'})} />
             </div>
          </div>
          <div className="flex flex-wrap items-baseline pl-4">
             <span>ใบประกอบวิชาชีพเวชกรรมเลขที่</span>
             <input type="text" name="approvingLicenseNo" value={formData.approvingLicenseNo} onChange={handleChange} className="dotted-line w-32 mx-2" />
             <span>รพ.</span>
             <input type="text" className="dotted-line w-40 mx-2" />
             <span>จังหวัด</span>
             <input type="text" className="dotted-line flex-grow mx-2" />
          </div>

          <div className="flex flex-wrap items-baseline">
             <span>* ลงชื่อแพทย์ ผู้ยุติการตั้งครรภ์</span>
             <input type="text" name="performingDoctorName" value={formData.performingDoctorName} onChange={handleChange} className="dotted-line w-40 mx-2" />
             <span>รพ.</span>
             <input type="text" name="performingHospital" value={formData.performingHospital} onChange={handleChange} className="dotted-line w-32 mx-2" />
             <span>ใบประกอบวิชาชีพเวชกรรมเลขที่</span>
             <input type="text" name="performingLicenseNo" value={formData.performingLicenseNo} onChange={handleChange} className="dotted-line flex-grow mx-2" />
          </div>

           <div className="flex flex-wrap items-baseline">
             <span>การวินิจฉัยโรค</span>
             <input type="text" name="diagnosis" value={formData.diagnosis} onChange={handleChange} className="dotted-line flex-grow mx-2 text-left pl-2" />
             <span>วันที่ ...... เดือน ............ พ.ศ. ........</span>
          </div>
        </div>

      </div>
    </div>
  );
};

// --- Main App Component ---

const App = () => {
  const [activeTab, setActiveTab] = useState('ga');

  const tabs = [
    { id: 'ga', label: 'คำนวณอายุครรภ์', icon: <Calculator className="w-5 h-5" /> },
    { id: '9q', label: 'คัดกรองซึมเศร้า 9Q', icon: <Activity className="w-5 h-5" /> },
    { id: 'record', label: 'บันทึกการรักษา', icon: <ClipboardList className="w-5 h-5" /> },
  ];

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-900">
      
      {/* Header */}
      <header className="bg-white shadow-sm border-b border-pink-100 sticky top-0 z-50 print:hidden">
        <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="bg-pink-600 text-white p-2 rounded-lg">
              <HeartPulse className="w-6 h-6" />
            </div>
            <h1 className="text-xl font-bold text-gray-800 hidden sm:block">RSA Health Service</h1>
          </div>
          
          <nav className="flex bg-gray-100 p-1 rounded-lg">
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`
                  flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-all
                  ${activeTab === tab.id 
                    ? 'bg-white text-pink-600 shadow-sm' 
                    : 'text-gray-500 hover:text-gray-700'}
                `}
              >
                {tab.icon}
                <span className="hidden sm:inline">{tab.label}</span>
              </button>
            ))}
          </nav>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-5xl mx-auto px-4 py-8 print:p-0 print:max-w-none">
        
        {activeTab === 'ga' && (
          <div className="animate-fade-in-up print:hidden">
            <div className="mb-6 text-center">
              <h2 className="text-3xl font-bold text-gray-800">เครื่องมือคำนวณอายุครรภ์</h2>
              <p className="text-gray-500">สำหรับประเมินอายุครรภ์เบื้องต้นเพื่อวางแผนการรักษา</p>
            </div>
            <GACalculator />
          </div>
        )}

        {activeTab === '9q' && (
          <div className="animate-fade-in-up print:hidden">
             <div className="mb-6 text-center">
              <h2 className="text-3xl font-bold text-gray-800">แบบประเมินสุขภาพจิต (Interactive)</h2>
              <p className="text-gray-500">เครื่องมือคัดกรองเบื้องต้น (หากต้องการพิมพ์ใบรับรองแพทย์ให้ใช้เมนู "บันทึกการรักษา")</p>
            </div>
            <DepressionScreening />
          </div>
        )}

        <div className={activeTab === 'record' ? 'block' : 'hidden'}>
           <AbortionRecordForm />
        </div>

      </main>

      <style jsx global>{`
        @keyframes fade-in-up {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
          animation: fade-in-up 0.3s ease-out forwards;
        }
        @media print {
          body { background: white; }
          .print\\:hidden { display: none !important; }
          .print\\:p-0 { padding: 0 !important; }
          .print\\:max-w-none { max-width: none !important; }
          .print\\:shadow-none { box-shadow: none !important; }
        }
      `}</style>
    </div>
  );
};

export default App;
